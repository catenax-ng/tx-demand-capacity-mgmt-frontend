
  name: build

  on:
    push:
      branches:
        - 'DCMFOSS-32'
    
  
  env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}
   
  
  jobs:
    build-and-push-image:
      runs-on: ubuntu-latest
      permissions:
        contents: read
  
      steps:
        - name: Checkout repository
          uses: actions/checkout@v3
  
        - name: Install Dependencies
          run: yarn
  
        - name: Build Library and Portal
          run: yarn build
  
        - name: Docker meta
          id: meta
          uses: docker/metadata-action@v4
          with:
            images: |
              ${{ env.IMAGE_NAMESPACE }}/${{ env.IMAGE_NAME }}
            # Automatically prepare image tags; See action docs for more examples. 
            # semver patter will generate tags like these for example :1 :1.2 :1.2.3
            tags: |
              type=ref,event=branch
              type=ref,event=pr
              type=semver,pattern={{version}}
              type=semver,pattern={{major}}
              type=semver,pattern={{major}}.{{minor}}
  
        - name: Login to GitHub Container Registry
          if: github.event_name != 'pull_request'
          uses: docker/login-action@v1
          with:
            # Use existing DockerHub credentials present as secrets
            registry: ${{ env.REGISTRY }}
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}
  
        
  
        - name: Build and push Docker image
          uses: docker/build-push-action@v4
          with:
            context: .
            file: ./build/Dockerfile
            push: ${{ github.event_name != 'pull_request' }}
            # build tag :latest
            tags: ${{ steps.meta.outputs.tags }}, ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            labels: ${{ steps.meta.outputs.labels }}